---
import { getEntry } from 'astro:content';

import { getSlugFromURL } from '@common/Path';
import Showcase from './Showcase';
import type { Project } from 'types/project';

import { components } from '@common/mdx/Components.astro';
import HomeSection from '@common/HomeSection/HomeSection.astro';

async function getPorfolio(): Promise<Project[]> {
  const all = await Astro.glob<Project>('src/collections/projects/*.mdx');
  return all
    .filter((page) => !page.frontmatter.draft)
    .sort((pageA, pageB) => {
      const dateA = new Date(pageA.frontmatter.date).getTime();
      const dateB = new Date(pageB.frontmatter.date).getTime();
      return dateB - dateA;
    })
    .map((page) => {
      return {
        ...page.frontmatter,
        url: '/portfolio/' + getSlugFromURL(page.file),
      };
    });
}

async function splitFeatured(all: Project[]): Promise<[Project[], Project[]]> {
  const featured: Project[] = [];
  const other: Project[] = [];
  all.forEach((project) => (project.featured ? featured : other).push(project));
  return [featured, other];
}

const [featured, other] = await splitFeatured(await getPorfolio());

const entry = await getEntry('home', 'portfolio');
const { Content } = await entry.render();
---

<HomeSection id='portfolio' class='bg-yellow-200'>
  <Fragment slot='title'>{entry.data.title}</Fragment>
  <Fragment>
    <Content components={components} />
    <Showcase featured={featured} other={other} client:idle />
  </Fragment>
</HomeSection>
